<html>

<head>
    <link rel="stylesheet" href="leap.css" type="text/css"></link>
    <script type="text/javascript" src="http://code.jquery.com/jquery-latest.min.js"></script>
    <script src="leapjs/leap-0.6.4.js"></script>
    <script>
        var context = new(window.AudioContext || window.webkitAudioContext)();
        var oscillator = context.createOscillator();

        var gainNode = context.createGain();
        gainNode.gain.value = 1;
        gainNode.connect(context.destination);
        oscillator.connect(gainNode);
        oscillator.start();

        var notes = [146.83, 164.81, 174.61, 196.00, 220.00, 246.94, 261.63, 293.66, 329.63, 349.23, 392.00, 440.00, 493.88, 523.25];
        var noteNames = ['D', 'E', 'F', 'G', 'A', 'B', 'C', 'D', 'E', 'F', 'G', 'A', 'B', "C"];

        console.log("LeapJS v" + Leap.version.full);
        var state = 'play';
        var vibrato;
        var haveLoggedFrame = false;
        var controller = new Leap.Controller({
            enableGestures: true
        });
        controller.loop(function(frame) {
            var findPinchingFingerType = function(hand) {
                var pincher;
                var closest = 500;
                for (var f = 1; f < 5; f++) {
                    current = hand.fingers[f];
                    distance = Leap.vec3.distance(hand.thumb.tipPosition, current.tipPosition);
                    if (current != hand.thumb && distance < closest) {
                        closest = distance;
                        pincher = current;
                    }
                }
                return pincher;
            }

            if (state == 'paused') return;
            if (state == 'pausing') {
                $('#out').html() = "<p><b>PAUSED</b></p><div>" + frame.dump() + "</div>";
                state = 'paused';
            } else { // Display Hand object data
                var handString = "";
                var noteString = "";
                var palmPos, vibrato = 0;
                var hand = frame.hands[0];
                if (frame.hands.length == 1 && frame.hands[0].type == "right") {
                    var type = hand.type;
                    vibrato = hand.palmVelocity[0];
                    palmPos = Math.round(hand.palmPosition[1]);
                    var pixel = ((4 * palmPos) - 400);
                } else if (frame.hands.length == 2) {
                    var volHand = frame.hands[1];
                    var pitch = volHand.pitch();
                    if (pitch < 0) {
                        gainNode.gain.value = 0;
                    } else {
                        gainNode.gain.value = pitch;
                    }
                    $('#letter').css('opacity', gainNode.gain.value);
                    vibrato = hand.palmVelocity[0];
                    palmPos = Math.round(hand.palmPosition[1]);
                }
            }
            if (frame.hands.length > 0 && hand.pinchStrength > 0) {
                $('#note').css('-webkit-transition', '0s');
                $('#home').hide();
                if (palmPos != undefined) {
                    var freq = ((palmPos + 50) + Math.abs(vibrato/10)).toFixed(2);
                    oscillator.frequency.value = freq;
                    handString = "Frequency: " + freq + ' Hz';
                    for (var i = 0; i < notes.length; i++) {
                        if ((palmPos + 50) - notes[i] < 20) {
                            noteString += noteNames[i];
                            break;
                        }
                    }
                }
                $('#note').css({
                    height: (4 * palmPos) - 400 + 'px'
                });
                var pinchingFinger = findPinchingFingerType(hand);
            } else {
                $('#note').css('-webkit-transition', '2s');
                $('#home').show();
                oscillator.frequency.value = 0;
                $('#note').css({
                    height: 0
                });
                gainNode.gain.value = 1;
            }
            $('#out').html(handString);
            $('#letter').html(noteString);

            //document.getElementById('out').innerHTML = "<p>spacebar to pause</p><div>" + handString + "</div>";

            if (haveLoggedFrame == false && frame.hands[0]) {
                console.log(frame);
                haveLoggedFrame = true;
            }
        });
        // Note that this means Leap is connected, but not streaming.  Use streamingStarted for that.
        controller.on('ready', function() {
            console.log("ready. Service version: " + controller.connection.protocol.serviceVersion);
        });
        controller.on('connect', function() {
            console.log("connected with protocol v" + controller.connection.opts.requestProtocolVersion);
        });
        controller.on('disconnect', function() {
            console.log("disconnect");
        });
        // This event is always called after other frame events, and is ideal for rendering WebGL scenes.
        // The timestamp is from requestAnimationFrame and is when the pixels hit the screen.
        // handString += "Palm position x: " + Math.round(hand.palmPosition[0]) + " mm<br />";
        // handString += "Palm position y: " + Math.round(hand.palmPosition[1]) + " mm<br />";
        // handString += "Palm velocity x : " + Math.round(hand.palmVelocity[0]) + " mm/s<br />";
        // handString += "Palm velocity y : " + Math.round(hand.palmVelocity[1]) + " mm/s<br />";
        // handString += "Hand Type: " + frame.hands[0].type + "<br/>";
        // handString += "Hand ID: " + hand.id + "<br />";
        controller.on('frameEnd', function(timestamp) {
            //        console.log('frameEnd', timestamp);
        });
    </script>
</head>

<body>
    <div id="tint"></div>
    <div id="out" align="right"></div>
    <div id="note"></div>

    <div id="letter" align="center"></div>
    <div id="c"></div>
    <a id="home" align="center" href="index.html">Home</a>
</body>

</html>
